<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión PSI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#6c5ce7">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/color/180/brain--v1.png?v=1">
    <link rel="icon" type="image/png" sizes="180x180" href="https://img.icons8.com/color/180/brain--v1.png?v=1">
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background-color: #050505; overflow: hidden; }
        iframe { border: none; width: 100%; height: 100%; display: block; background-color: #050505; }
    </style>
</head>
<body>
    <!-- RECUERDA PONER TU URL REAL DE GOOGLE SCRIPT AQUÍ -->
    <iframe id="appFrame" src="https://script.google.com/macros/s/AKfycbxZfMM-RlGFW5MJNxIKmQBIRGM5Zuy28NBzCgWK8T5MvRZ4WlBSpr49322GPX2qJ5IxlQ/exec" allow="geolocation; microphone; camera; fullscreen"></iframe>

    <script>
        const frame = document.getElementById('appFrame');

        // 1. FUNCIÓN: ENVIAR DATOS AL IFRAME (PUSH)
        function enviarCredenciales() {
            const user = localStorage.getItem('usuario_gestion_psi');
            const token = localStorage.getItem('token_gestion_psi');
            const cache = localStorage.getItem('psi_data_cache');
            
            // Enviamos con origen '*' para asegurar que llegue
            if (frame && frame.contentWindow) {
                frame.contentWindow.postMessage({
                    action: 'INIT_RESPONSE',
                    user: user,
                    token: token,
                    cache: cache
                }, '*');
            }
        }

        // 2. DISPARADOR: APENAS CARGA EL IFRAME, LE INYECTAMOS LOS DATOS
        frame.onload = function() {
            // Enviamos inmediatamente
            enviarCredenciales();
            // Y reenviamos a los 500ms y 1500ms por seguridad (iOS a veces es lento)
            setTimeout(enviarCredenciales, 500);
            setTimeout(enviarCredenciales, 1500);
        };

        // 3. ESCUCHA: GUARDAR LO QUE MANDE LA APP
        window.addEventListener('message', function(e) {
            if (e.data.action === 'SAVE') {
                localStorage.setItem(e.data.key, e.data.value);
            }
        });
    </script>
</body>
</html>
